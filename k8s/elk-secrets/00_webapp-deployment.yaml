---
# Combined demo web application that displays both static and dynamic secrets
apiVersion: apps/v1
kind: Deployment
metadata:
  name: elk-dynamic-webapp
  namespace: vault-stack
  labels:
    app: elk-dynamic-webapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elk-dynamic-webapp
  template:
    metadata:
      labels:
        app: elk-dynamic-webapp
      annotations:
        # Force pod restart when dynamic credentials are rotated
        vault.hashicorp.com/agent-inject: "false"
    spec:
      serviceAccountName: elk-dynamic-webapp-svc-acc
      containers:
        - name: webapp
          image: python:3.11-alpine
          command: ["/bin/sh"]
          args:
            - -c
            - |
              # Install required packages (elasticsearch<9 for compatibility with ES 8.12)
              pip install --no-cache-dir 'elasticsearch<9' requests urllib3 > /dev/null 2>&1

              cat > /tmp/app.py <<'PYEOF'
              from http.server import HTTPServer, BaseHTTPRequestHandler
              from elasticsearch import Elasticsearch
              import os
              import json
              import traceback
              from datetime import datetime

              class CombinedSecretsHandler(BaseHTTPRequestHandler):
                  def do_GET(self):
                      html = self.generate_html()
                      self.send_response(200)
                      self.send_header('Content-type', 'text/html')
                      self.end_headers()
                      self.wfile.write(html.encode())

                  def generate_html(self):
                      # Read static secrets from environment variables (VSO synced)
                      static_username = os.getenv('STATIC_USERNAME', None)
                      static_password = os.getenv('STATIC_PASSWORD', None)
                      static_es_host = os.getenv('STATIC_ES_HOST', None)
                      static_es_port = os.getenv('STATIC_ES_PORT', None)
                      static_es_protocol = os.getenv('STATIC_ES_PROTOCOL', None)
                      static_es_url = os.getenv('STATIC_ES_URL', None)
                      static_es_username = os.getenv('STATIC_ES_USERNAME', None)
                      static_es_password = os.getenv('STATIC_ES_PASSWORD', None)
                      static_es_index = os.getenv('STATIC_ES_INDEX', None)

                      # Read dynamic credentials from mounted files (auto-updated!)
                      dynamic_es_username = None
                      dynamic_es_password = None
                      try:
                          with open('/vault/secrets/username', 'r') as f:
                              dynamic_es_username = f.read().strip()
                          with open('/vault/secrets/password', 'r') as f:
                              dynamic_es_password = f.read().strip()
                      except FileNotFoundError:
                          pass  # Dynamic secrets not configured
                      except Exception as e:
                          dynamic_es_username = f'ERROR: {e}'
                          dynamic_es_password = 'ERROR'

                      # Build HTML sections
                      static_section = self.render_static_secrets(
                          static_username, static_password,
                          static_es_host, static_es_port, static_es_protocol,
                          static_es_url, static_es_username, static_es_password, static_es_index
                      )

                      dynamic_section = self.render_dynamic_secrets(
                          dynamic_es_username, dynamic_es_password
                      )

                      # Try to connect to Elasticsearch
                      connection_section = self.test_elasticsearch_connection(
                          dynamic_es_username, dynamic_es_password,
                          static_es_username, static_es_password
                      )

                      return f'''<!DOCTYPE html>
              <html>
              <head>
                  <title>Vault Secrets Demo</title>
                  <meta http-equiv="refresh" content="30">
                  <style>
                      body {{
                          font-family: Arial, sans-serif;
                          max-width: 1200px;
                          margin: 50px auto;
                          padding: 20px;
                          background-color: #f5f5f5;
                      }}
                      .container {{
                          background-color: white;
                          border-radius: 8px;
                          padding: 30px;
                          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      }}
                      h1 {{
                          color: #333;
                          border-bottom: 3px solid #7B42BC;
                          padding-bottom: 10px;
                      }}
                      h2 {{
                          color: #555;
                          margin-top: 30px;
                      }}
                      .secret-section {{
                          background-color: #f9f9f9;
                          border-left: 4px solid #00d4aa;
                          padding: 15px;
                          margin: 15px 0;
                      }}
                      .credential-section {{
                          background-color: #f9f9f9;
                          border-left: 4px solid #7B42BC;
                          padding: 15px;
                          margin: 15px 0;
                      }}
                      .secret-item, .credential-item {{
                          margin: 10px 0;
                          font-family: monospace;
                          word-break: break-all;
                      }}
                      .label {{
                          font-weight: bold;
                          color: #666;
                      }}
                      .value {{
                          color: #7B42BC;
                      }}
                      .value-static {{
                          color: #00d4aa;
                      }}
                      .info {{
                          background-color: #e3f2fd;
                          border-left: 4px solid #2196f3;
                          padding: 15px;
                          margin: 20px 0;
                      }}
                      .success {{
                          background-color: #e8f5e9;
                          border-left: 4px solid #4caf50;
                          padding: 15px;
                          margin: 20px 0;
                      }}
                      .error {{
                          background-color: #ffebee;
                          border-left: 4px solid #f44336;
                          padding: 15px;
                          margin: 20px 0;
                      }}
                      .warning {{
                          background-color: #fff3e0;
                          border-left: 4px solid #ff9800;
                          padding: 15px;
                          margin: 20px 0;
                      }}
                      .timestamp {{
                          color: #999;
                          font-size: 0.9em;
                          text-align: right;
                      }}
                      .two-column {{
                          display: grid;
                          grid-template-columns: 1fr 1fr;
                          gap: 20px;
                      }}
                      @media (max-width: 768px) {{
                          .two-column {{
                              grid-template-columns: 1fr;
                          }}
                      }}
                  </style>
              </head>
              <body>
                  <div class="container">
                      <h1>üîê Vault Secrets Demonstration</h1>

                      <div class="info">
                          <strong>‚ÑπÔ∏è About this demonstration:</strong><br>
                          This application displays both <strong>static secrets</strong> (synced via Vault Secrets Operator)
                          and <strong>dynamic credentials</strong> (generated on-demand by Vault's database secrets engine).
                      </div>

                      <div class="two-column">
                          {static_section}
                          {dynamic_section}
                      </div>

                      {connection_section}

                      <div class="timestamp">
                          Last updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}<br>
                          Auto-refresh: 30 seconds
                      </div>
                  </div>
              </body>
              </html>'''

                  def render_static_secrets(self, username, password, es_host, es_port,
                                          es_protocol, es_url, es_username, es_password, es_index):
                      if not any([username, password, es_host, es_username, es_password]):
                          return '''
                      <div>
                          <h2>üìù Static Secrets (VSO)</h2>
                          <div class="warning">
                              <strong>‚ö†Ô∏è Static secrets not found</strong><br>
                              Deploy static secrets using: <code>task elk:static</code>
                          </div>
                      </div>'''

                      return f'''
                      <div>
                          <h2>üìù Static Secrets (VSO)</h2>
                          <div class="info">
                              These secrets are synced from Vault by the Vault Secrets Operator (VSO).
                          </div>

                          <h3>Web Application Credentials</h3>
                          <div class="secret-section">
                              <div class="secret-item">
                                  <span class="label">Username:</span> <span class="value-static">{username or 'N/A'}</span>
                              </div>
                              <div class="secret-item">
                                  <span class="label">Password:</span> <span class="value-static">{password or 'N/A'}</span>
                              </div>
                          </div>

                          <h3>Elasticsearch Configuration</h3>
                          <div class="secret-section">
                              <div class="secret-item">
                                  <span class="label">Host:</span> <span class="value-static">{es_host or 'N/A'}</span>
                              </div>
                              <div class="secret-item">
                                  <span class="label">Port:</span> <span class="value-static">{es_port or 'N/A'}</span>
                              </div>
                              <div class="secret-item">
                                  <span class="label">Protocol:</span> <span class="value-static">{es_protocol or 'N/A'}</span>
                              </div>
                              <div class="secret-item">
                                  <span class="label">URL:</span> <span class="value-static">{es_url or 'N/A'}</span>
                              </div>
                              <div class="secret-item">
                                  <span class="label">Username:</span> <span class="value-static">{es_username or 'N/A'}</span>
                              </div>
                              <div class="secret-item">
                                  <span class="label">Password:</span> <span class="value-static">{es_password or 'N/A'}</span>
                              </div>
                              <div class="secret-item">
                                  <span class="label">Index:</span> <span class="value-static">{es_index or 'N/A'}</span>
                              </div>
                          </div>
                      </div>'''

                  def render_dynamic_secrets(self, username, password):
                      if not username or not password:
                          return '''
                      <div>
                          <h2>üîÑ Dynamic Credentials</h2>
                          <div class="warning">
                              <strong>‚ö†Ô∏è Dynamic credentials not found</strong><br>
                              Deploy dynamic credentials using: <code>task elk:dynamic</code>
                          </div>
                      </div>'''

                      return f'''
                      <div>
                          <h2>üîÑ Dynamic Credentials</h2>
                          <div class="info">
                              These credentials are generated on-demand by Vault's database secrets engine.
                          </div>

                          <h3>Current Dynamic Credentials</h3>
                          <div class="credential-section">
                              <div class="credential-item">
                                  <span class="label">Username:</span> <span class="value">{username}</span>
                              </div>
                              <div class="credential-item">
                                  <span class="label">Password:</span> <span class="value">{password}</span>
                              </div>
                              <div class="credential-item">
                                  <span class="label">Default TTL:</span> <span class="value">5 minutes</span>
                              </div>
                              <div class="credential-item">
                                  <span class="label">Max TTL:</span> <span class="value">5 minutes</span>
                              </div>
                              <div class="credential-item">
                                  <span class="label">Lease Renewal:</span> <span class="value">Every 60 seconds</span>
                              </div>
                          </div>
                      </div>'''

                  def test_elasticsearch_connection(self, dynamic_username, dynamic_password,
                                                    static_username, static_password):
                      # Try dynamic credentials first, then static
                      username = dynamic_username if dynamic_username else static_username
                      password = dynamic_password if dynamic_password else static_password
                      cred_type = "dynamic" if dynamic_username else "static" if static_username else None

                      if not username or not password:
                          return '''
                      <h2>üîå Elasticsearch Connection Test</h2>
                      <div class="warning">
                          <strong>‚ö†Ô∏è No credentials available</strong><br>
                          Deploy either static or dynamic secrets to test Elasticsearch connectivity.
                      </div>'''

                      connection_status = "Not attempted"
                      index_count = "N/A"
                      error_message = ""

                      try:
                          es = Elasticsearch(
                              "https://host.minikube.internal:9200",
                              basic_auth=(username, password),
                              verify_certs=False,
                              ssl_show_warn=False,
                              request_timeout=10,
                              max_retries=3,
                              retry_on_timeout=True
                          )

                          # Use info() instead of ping() for more reliable connection testing
                          info = es.info()
                          connection_status = "‚úÖ Connected successfully"
                          # Get index count
                          indices = es.cat.indices(format='json')
                          index_count = len(indices) if indices else 0
                      except Exception as e:
                          connection_status = "‚ùå Error connecting"
                          error_message = str(e)

                      error_html = f'<div class="error"><strong>Error:</strong> {error_message}</div>' if error_message else ''

                      return f'''
                      <h2>üîå Elasticsearch Connection Test</h2>
                      <div class="credential-section">
                          <div class="credential-item">
                              <span class="label">Using credentials:</span> <span class="value">{cred_type.capitalize()}</span>
                          </div>
                          <div class="credential-item">
                              <span class="label">Status:</span> <span class="value">{connection_status}</span>
                          </div>
                          <div class="credential-item">
                              <span class="label">Indices Count:</span> <span class="value">{index_count}</span>
                          </div>
                          {error_html}
                      </div>'''

              if __name__ == '__main__':
                  server = HTTPServer(('0.0.0.0', 80), CombinedSecretsHandler)
                  print('Starting combined secrets server on port 80...')
                  server.serve_forever()
              PYEOF

              # Start the Python web server
              python3 /tmp/app.py

          ports:
            - containerPort: 80

          env:
            # Static secrets from VSO (webapp-secret)
            - name: STATIC_USERNAME
              valueFrom:
                secretKeyRef:
                  name: webapp-secret
                  key: username
                  optional: true
            - name: STATIC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: webapp-secret
                  key: password
                  optional: true

            # Static secrets from VSO (elasticsearch-secret)
            - name: STATIC_ES_HOST
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-secret
                  key: es_host
                  optional: true
            - name: STATIC_ES_PORT
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-secret
                  key: es_port
                  optional: true
            - name: STATIC_ES_PROTOCOL
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-secret
                  key: es_protocol
                  optional: true
            - name: STATIC_ES_URL
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-secret
                  key: es_url
                  optional: true
            - name: STATIC_ES_USERNAME
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-secret
                  key: es_username
                  optional: true
            - name: STATIC_ES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-secret
                  key: es_password
                  optional: true
            - name: STATIC_ES_INDEX
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-secret
                  key: es_index
                  optional: true

          volumeMounts:
            # Mount dynamic credentials as files (auto-updated without pod restart)
            - name: dynamic-creds
              mountPath: /vault/secrets
              readOnly: true

          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi

      volumes:
        # Mount the dynamic credentials secret as a volume (optional)
        - name: dynamic-creds
          secret:
            secretName: elasticsearch-dynamic-secret
            optional: true

---
# Service to expose the webapp
apiVersion: v1
kind: Service
metadata:
  name: elk-dynamic-webapp-service
  namespace: vault-stack
  labels:
    app: elk-dynamic-webapp
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
      name: http
  selector:
    app: elk-dynamic-webapp
