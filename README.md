## Overview

This stack deploys a complete Vault Enterprise environment on Kubernetes with:
- **Security**: Vault Enterprise with Raft storage backend
- **Monitoring**: Grafana, Prometheus, Loki, Promtail
- **Data Services**: Elasticsearch, Kibana (via ECK operator)
- **Observability**: Unified logging and metrics collection

## Prerequisites

- Kubernetes cluster (1.20+)
- `kubectl` configured and connected to the cluster
- `terraform` (>= 1.5.0) - Infrastructure as Code
- `task` (Task runner)
- `jq` (JSON processor)
- Vault Enterprise license (add to `licenses/vault-enterprise/license.lic`)

## Quick Start

### 1. Clone Repository

```bash
git clone <repository-url>
cd kubernetes-vault-stack
```

### 2. Configure Vault License

Add your Vault Enterprise license:

```bash
# Copy the license template
cp licenses/vault-enterprise/license.lic.example licenses/vault-enterprise/license.lic

# Edit the license file and add your actual license key
# Replace YOUR_VAULT_ENTERPRISE_LICENSE_KEY_HERE with your actual license
```

### 3. Deploy Everything (Automated)

```bash
task up        # Deploy infrastructure
task init      # Initialize Vault
task unseal    # Unseal Vault and start port forwarding
```

That's it! These three commands:
- ✅ Deploy all infrastructure (Terraform)
- ✅ Generate TLS certificates
- ✅ Create Kubernetes secrets
- ✅ Deploy Helm charts (Vault, ELK, Grafana, Prometheus, Loki)
- ✅ Initialize Vault
- ✅ Unseal Vault
- ✅ Set up port forwarding automatically
- ✅ Update `.env` with Vault token

Services are now accessible at:
- **Vault**: http://localhost:8200
- **Grafana**: http://localhost:3000
- **Prometheus**: http://localhost:9090
- **Kibana**: https://localhost:5601
- **Elasticsearch**: https://localhost:9200

### 4. Use Vault CLI

```bash
source .env
vault status
vault secrets list
```

### 5. View Access Information

```bash
task info
```

## Available Commands

```bash
task              # List all available commands
task up           # Deploy the entire stack (Terraform)
task init         # Initialize Vault
task unseal       # Unseal Vault and start port forwarding
task status       # Show status of all components
task info         # Show access information and credentials
task logs         # View logs for a service (usage: task logs -- <service-name>)
task shell        # Open a shell in the Vault pod
task clean        # Destroy the entire stack (Terraform)
task rm           # Alias for clean
```

## Accessing Services

After running `task unseal`, port forwarding is automatically set up and services are available at:

- **Vault UI**: http://localhost:8200/ui
- **Vault CLI**: `source .env && vault status`
- **Grafana**: http://localhost:3000
- **Prometheus**: http://localhost:9090
- **Elasticsearch**: https://localhost:9200
- **Kibana**: http://localhost:5601

## Credentials

### Vault
After running `task init`, credentials are saved to:
- **Root Token**: `.env` file (also in `vault-init.json`)
- **Unseal Key**: `vault-init.json`

To use Vault CLI:
```bash
source .env
vault status
vault secrets list
```

### Service Credentials

Credentials are managed as follows:

- **Elasticsearch**: Password is auto-generated by ECK operator and stored in Kubernetes secret `elasticsearch-es-elastic-user`
- **Kibana**: Uses Elasticsearch credentials (user: `elastic`)
- **Grafana**: Default credentials: `admin` / `admin` (configured in `helm-chart/vault-stack/values/grafana/grafana.yaml`)

To view all credentials:
```bash
task info
```

Or retrieve Elasticsearch password manually:
```bash
kubectl get secret elasticsearch-es-elastic-user -n vault-stack -o jsonpath='{.data.elastic}' | base64 -d
```

**Note**: Default credentials are set for development convenience.

## Usage Examples

### View Component Status

```bash
task status
```

Shows:
- Pod status
- Services
- Vault status (initialized, sealed state)

### View Service Logs

```bash
# View Vault logs
task logs -- vault

# View Elasticsearch logs
task logs -- elasticsearch

# View Kibana logs
task logs -- kibana

# Without service name, shows available services
task logs
```

### Access Vault Shell

```bash
task shell
```

Opens an interactive shell inside the Vault pod.

### Clean and Redeploy

```bash
# Destroy everything
task clean    # or: task rm

# Redeploy from scratch
task up
task init
task unseal
```

## Configuration

### Terraform Variables

Infrastructure configuration is managed via Terraform variables in `terraform/variables.tf`:

```hcl
namespace              = "vault-stack"           # Kubernetes namespace
release_name           = "vault-stack"           # Helm release name
chart_path             = "../helm-chart/vault-stack"
vault_license_file     = "../licenses/vault-enterprise/license.lic"
cert_validity_hours    = 8760                    # Certificate validity (1 year)
```

To customize, create a `terraform.tfvars` file:

```hcl
namespace = "my-vault"
cert_validity_hours = 17520  # 2 years
```

See `terraform/README.md` for full documentation.

### Helm Values

The deployment uses a modular values structure in `helm-chart/vault-stack/values/`:

```
values/
├── global/global.yaml          # Global settings (namespace)
├── vault/vault.yaml            # Vault Enterprise configuration and secrets
├── elasticsearch/elasticsearch.yaml  # ECK operator configuration
├── grafana/grafana.yaml        # Grafana configuration
├── prometheus/prometheus.yaml  # Prometheus configuration
├── loki/loki.yaml             # Loki configuration
└── promtail/promtail.yaml     # Promtail configuration
```

Each service has its own values file for easy customization:

- Resource limits and requests
- Replica counts
- Storage sizes
- Enable/disable components

After making changes:

```bash
task clean
task up
```

### Environment Variables

The `.env` file is automatically created by Terraform during `task up` and contains:

```bash
# Vault address - required for Vault CLI commands
export VAULT_ADDR=http://127.0.0.1:8200

# Vault Enterprise license - read from licenses/vault-enterprise/license.lic
export VAULT_LICENSE=<auto-populated-from-license-file>

# Vault root token - dynamically generated during 'task init'
export VAULT_TOKEN=<auto-populated-during-init>
```

**Note**:
- The `.env` file is automatically created by Terraform - you don't need to create it manually
- Vault license is automatically read from `licenses/vault-enterprise/license.lic` and embedded in `.env`
- Vault root token is generated and updated in `.env` during `task init`
- Unseal key is stored only in `vault-init.json`, not in `.env`
- The `.env` file is destroyed when running `task clean`

## Architecture

### Components

All components use official Helm charts from vendors:

- **Vault Enterprise** (HashiCorp) - Secret management with Raft storage backend
- **Elasticsearch** (Elastic via ECK) - Log storage with TLS enabled
- **Kibana** (Elastic via ECK) - Log visualization and exploration
- **Prometheus** (Prometheus Community) - Metrics collection and monitoring
- **Grafana** (Grafana) - Unified observability dashboard
- **Loki** (Grafana) - Log aggregation system
- **Promtail** (Grafana) - Log collector for Kubernetes

### TLS/Certificates

TLS certificates are automatically generated by Terraform using the `tls` provider:
- Self-signed CA certificate
- Vault server certificate (signed by CA)
- Elasticsearch certificates (using same CA)
- Kibana certificates (with CA verification)

Certificates are valid for 1 year (8760 hours) by default. Customize with `cert_validity_hours` variable.

## Troubleshooting

### Check Prerequisites

```bash
task pre-deploy-checks
```

### Pod Not Starting

```bash
# Check pod status
task status

# View pod logs
task logs -- <pod-name>

# Describe pod for events
kubectl describe pod -n vault-stack <pod-name>
```

### Vault is Sealed After Restart

Vault needs to be unsealed after pod restarts:

```bash
task unseal
```

Or manually:

```bash
kubectl exec -n vault-stack vault-0 -- vault status
UNSEAL_KEY=$(cat vault-init.json | jq -r '.unseal_keys_b64[0]')
kubectl exec -n vault-stack vault-0 -- vault operator unseal $UNSEAL_KEY
```

### Port-Forwards Not Responding

If port-forwards stop working, restart them:

```bash
./scripts/20_port_forwarding.sh
```

### Cannot Connect to Kubernetes Cluster

```bash
# Check cluster connection
kubectl cluster-info

# Check current context
kubectl config current-context

# List available contexts
kubectl config get-contexts
```

## Infrastructure as Code

This project uses **Terraform** to manage all Kubernetes infrastructure:

- **Namespace** creation
- **TLS certificate** generation
- **Kubernetes secrets** (certificates, license)
- **Helm chart** deployments
- **ECK operator** deployment

### Why Terraform?

- **Declarative** - Define desired state, Terraform handles the rest
- **State management** - Track infrastructure changes over time
- **Idempotent** - Safe to run multiple times
- **Version controlled** - Infrastructure changes in git
- **Modular** - Reusable modules for certificates, secrets, Helm releases

### Terraform Structure

```
terraform/
├── main.tf              # Main configuration
├── variables.tf         # Input variables
├── outputs.tf           # Output values
├── providers.tf         # Provider configuration
├── modules/
│   ├── certificates/    # TLS certificate generation
│   ├── secrets/         # Kubernetes secrets
│   └── helm-releases/   # Helm chart deployments
└── README.md            # Terraform documentation
```

See `terraform/README.md` for detailed Terraform documentation.

### Remaining Shell Scripts

A few shell scripts remain for operational tasks (not infrastructure):
- Vault init (`30_vault_init.sh`) - One-time initialization
- Vault unseal (`40_vault_unseal.sh`) - Runtime unsealing
- Status and info commands (`tools/status.sh`, `tools/info.sh`) - Information display

These cannot be replaced with Terraform as they are runtime operations, not infrastructure provisioning.

## Development

### Adding New Services

1. Add official Helm chart dependency to `helm-chart/vault-stack/Chart.yaml`
2. Create new values file in `helm-chart/vault-stack/values/<service>/<service>.yaml`
3. Update Terraform module in `terraform/modules/helm-releases/main.tf` to include new values file
4. Add NodePort service in `terraform/main.tf` if external access needed
5. Update `task port-forward` in `Taskfile.yaml` if using port forwarding
6. Update `task info` in `scripts/tools/info.sh` for credential display
